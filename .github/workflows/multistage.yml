name: Multistage build

on: 
  push:
    branches: ["*"]
  pull_request: 
    branches: ["*"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: QEMU install
        uses: docker/setup-qemu-action@v3
      
      - name: Install Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      - name: build ls
        run: docker buildx ls
      
      - name: Log in to dockerhub
        run: docker login -u ${{ vars.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build Dockerfile image for amd64
        run: docker build --platform=linux/amd64 -t babenkovalera/multistage:amd64 --push .
      
      - name: Build Dockerfile image for arm64
        run: docker build --platform=linux/arm64 -t babenkovalera/multistage:arm64 --push .
      
      - name: Create manifest
        run: docker manifest create babenkovalera/multistage --amend babenkovalera/multistage:amd64 --amend babenkovalera/multistage:arm64
      
      - name: Push manifest to dockerhub
        run: docker manifest push babenkovalera/multistage
